<!DOCTYPE html>
<html lang="{{ site.lang | default: " en-US" }}">

<head>
  <meta charset="UTF-8">
  <title>{{ page.title | default: site.title }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" type="text/css"
    href="{{ '/assets/css/style.css?v=' | append: site.github.build_revision | relative_url }}">
  <link rel="stylesheet" type="text/css" href="{{ '/assets/css/custom.css' | relative_url }}">
  {% seo %}
  <script src="{{ '/assets/js/fuse.min.js' | relative_url }}"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const searchInput = document.getElementById('search-input');
    const resultsContainer = document.getElementById('search-results');
    let fuse;

    // --- HELPER FUNCTION TO APPLY HIGHLIGHTS ---
    function applyHighlights(text, indices) {
      // Sort indices by start position
      indices.sort((a, b) => a[0] - b[0]);
      let result = '';
      let lastIndex = 0;

      indices.forEach(index => {
        const [start, end] = index;
        // Append text before the highlight
        result += text.substring(lastIndex, start);
        // Append the highlighted text
        result += `<mark>${text.substring(start, end + 1)}</mark>`;
        lastIndex = end + 1;
      });

      // Append the remaining text after the last highlight
      result += text.substring(lastIndex);
      return result;
    }

    document.addEventListener('click', (event) => {
      if (!searchInput.contains(event.target) && !resultsContainer.contains(event.target)) {
        resultsContainer.innerHTML = '';
      }
    });

    fetch('{{ "/search.json" | relative_url }}')
      .then(response => response.json())
      .then(data => {
        const options = {
          keys: [
            { name: 'title', weight: 2 },
            { name: 'content', weight: 1 }
          ],
          includeScore: true,
          // --- NEW: Enable match data for highlighting ---
          includeMatches: true, 
          threshold: 0.4,
          minMatchCharLength: 1,
        };
        fuse = new Fuse(data, options);
      })
      .catch(error => console.error('Error fetching or parsing search data:', error));

    searchInput.addEventListener('input', () => {
      const query = searchInput.value;
      
      if (query.length > 0) {
        if (!fuse) { return; }

        const results = fuse.search(query);
        resultsContainer.innerHTML = '';

        if (results.length === 0) {
          const noResultsLi = document.createElement('li');
          noResultsLi.className = 'no-results';
          noResultsLi.textContent = '未找到结果';
          resultsContainer.appendChild(noResultsLi);
        } else {
          results.slice(0, 100).forEach(result => {
            const li = document.createElement('li');
            let highlightedSnippet = '';

            // Get a simple text snippet
            const textSnippet = result.item.content.substring(0, 120);

            // Find matches within the content
            const contentMatches = result.matches.find(match => match.key === 'content');

            if (contentMatches) {
              // Filter indices to only those within our snippet length
              const snippetIndices = contentMatches.indices.filter(index => index[1] < 120);
              highlightedSnippet = applyHighlights(textSnippet, snippetIndices);
            } else {
              highlightedSnippet = textSnippet; // Fallback to non-highlighted snippet
            }

            li.innerHTML = `
              <a href="${result.item.url}">${result.item.title}</a>
              <p class="search-result-snippet">${highlightedSnippet}...</p>
            `;
            resultsContainer.appendChild(li);
          });
        }
      } else {
        resultsContainer.innerHTML = '';
      }
    });
  });
</script>
</head>

<body>
  <div class="wrapper">
    <header>
      <h1>{{ site.title | default: site.github.repository_name }}</h1>
      <p>{{ site.description | default: site.github.project_tagline }}</p>

      <!-- {% include navigation.html %} -->

    </header>
    <section>
      <div class="search-container">
        <label for="search-input" class="visually-hidden">搜索</label> <svg class="search-icon"
          xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
        <input type="text" id="search-input" placeholder="全站搜索（仅显示前一百条结果～）">
        <ul id="search-results"></ul>
      </div>
      {{ content }}

    </section>
    <footer>

      <!-- {% include contact_links.html %} -->

      <p><small>欢迎贡献： <a href="https://github.com/lyxmemo">Github:lyxmemo</a></small></p>
      <p><small>贡献者：寒庭暮晚、第N个日常、长亭怨慢、杜致童、睦月、__不要着急、观棋不语、刘兴汉、sage yan、鱼珠前航道舵手</small></p>
      <p><small>小红书：建楚bot</small></p>
      <p><small>邮箱：lyxmemo@gmail.com</small></p>
      <p><small>如果有您发现有其他适合添加的文章、书籍，或者在本站文章中发现错别字，请随时邮件我～</small></p>
    </footer>
  </div>
</body>

</html>